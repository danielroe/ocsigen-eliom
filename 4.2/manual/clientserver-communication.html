<html><head><title> Communication between the client and the server &amp;#182;</title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="https://ocsigen.org/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script type="text/javascript" src="https://ocsigen.org/js/client.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js">
//<![CDATA[

//]]>
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js">
//<![CDATA[

//]]>
</script></head><body class="clientserver-communication eliom"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href=".././../../" class="ocsimore_phrasing_link"><img src=".././../../img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Eliom</p><div class="mainmenu"><p class="mainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a></p><p class="mainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a></p><p class="mainmenu-current"><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a></p><p><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a></p><p><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a></p><p><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a></p><p><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a></p></div><form id="googlesearch" action="https://google.com/search"><input name="q" id="gsearch-box" placeholder="Search using Google"/><label for="gsearch-box"><img src="/img/search.svg" alt="" id="gsearch-icon"/></label><input type="submit" id="gsearch-submit" onclick="document.getElementById('gsearch-box').value += ' site:ocsigen.org';"/></form><aside class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigenserver/" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-toolkit/" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-project"><a href=".././../../html_of_wiki/" class="ocsimore_phrasing_link">html_of_wiki</a>
</li><li class="drawermainmenu-project"><a href=".././../../deriving/" class="ocsimore_phrasing_link">deriving</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsimore/" class="ocsimore_phrasing_link">Ocsimore (<em>deprecated</em>)</a>
</li><li class="drawermainmenu-page"><a href=".././../../projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href=".././../../papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href=".././../../credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href=".././../../contributing" class="ocsimore_phrasing_link">Contributing</a>
</li><li class="drawermainmenu-page"><a href=".././../../blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href=".././../../install" class="ocsimore_phrasing_link">Installation</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><nav class="how-doctree"><h1> Eliom's Reference manual</h1><h2><a href="intro" class="ocsimore_phrasing_link">Introduction</a></h2><h2>Server side programming</h2><h3>Services</h3><h4><a href="server-services" class="ocsimore_phrasing_link">The different types of services</a></h4><h4><a href="server-params" class="ocsimore_phrasing_link">Typing service parameters</a></h4><h4><a href="server-outputs" class="ocsimore_phrasing_link">Writing service handlers</a></h4><h4><a href="server-links" class="ocsimore_phrasing_link">Creating links and forms</a></h4><h3><a href="server-state" class="ocsimore_phrasing_link">Sessions and server side state</a></h3><h3><a href="server-security" class="ocsimore_phrasing_link">Security</a></h3><h2>Client-server programming</h2><h3><a href="clientserver-applications" class="ocsimore_phrasing_link">Eliom applications</a></h3><h3><a href="clientserver-language" class="ocsimore_phrasing_link">Client-server syntax</a></h3><h3><a href="clientserver-html" class="ocsimore_phrasing_link">Generating HTML5</a></h3><h3><a href="clientserver-communication" class="ocsimore_phrasing_link">Communication</a></h3><h3><a href="clientserver-mobile" class="ocsimore_phrasing_link">Mobile apps</a></h3><h3><a href="clientserver-wrapping" class="ocsimore_phrasing_link">Custom wrapping</a></h3><h2>Workflows</h2><h3><a href="workflow-distillery" class="ocsimore_phrasing_link">Distillery</a></h3><h3><a href="workflow-compilation" class="ocsimore_phrasing_link">Compilation</a></h3><h3><a href="workflow-configuration" class="ocsimore_phrasing_link">Configuration &amp; running</a></h3><h2><a href="examples" class="ocsimore_phrasing_link">Examples</a></h2><h2><a href="misc" class="ocsimore_phrasing_link">Miscellaneous</a></h2><h1>Eliom client API</h1><h2><a href=".././api/client/Eliom_pervasives" class="ocsimore_phrasing_link">Eliom_pervasives</a></h2><h2><a href=".././api/client/Eliom_lib" class="ocsimore_phrasing_link">Eliom_lib</a></h2><h2><a href=".././api/client/Eliom_client" class="ocsimore_phrasing_link">Eliom_client</a></h2><h2>Content and form creation</h2><h3><a href=".././api/client/Eliom_content.Html5" class="ocsimore_phrasing_link">Eliom_content.Html5</a></h3><h3><a href=".././api/client/Eliom_content.Svg" class="ocsimore_phrasing_link">Eliom_content.Svg</a></h3><h3><a href=".././api/client/Eliom_content.Xml" class="ocsimore_phrasing_link">Eliom_content.Xml</a></h3><h2>Client/server communication</h2><h3><a href=".././api/client/Eliom_service" class="ocsimore_phrasing_link">Eliom_service</a></h3><h3><a href=".././api/client/Eliom_bus" class="ocsimore_phrasing_link">Eliom_bus</a></h3><h3><a href=".././api/client/Eliom_comet" class="ocsimore_phrasing_link">Eliom_comet</a></h3><h3><a href=".././api/client/Eliom_react" class="ocsimore_phrasing_link">Eliom_react</a></h3><h2>Index</h2><h3> <span><a href=".././api/client/index_types">Index of types</a></span></h3><h3> <span><a href=".././api/client/index_exceptions">Index of exceptions</a></span></h3><h3> <span><a href=".././api/client/index_values">Index of values</a></span></h3><h3> <span><a href=".././api/client/index_class_types">Index of class types</a></span></h3><h3> <span><a href=".././api/client/index_modules">Index of modules</a></span></h3><h3> <span><a href=".././api/client/index_module_types">Index of module types</a></span></h3><h1>Server API</h1><h2><a href=".././api/server/Eliom_pervasives" class="ocsimore_phrasing_link">Eliom_pervasives</a></h2><h2><a href=".././api/server/Eliom_lib" class="ocsimore_phrasing_link">Eliom_lib</a></h2><h2><a href=".././api/server/Eliom_common" class="ocsimore_phrasing_link">Eliom_common</a></h2><h2><a href=".././api/server/Eliom_config" class="ocsimore_phrasing_link">Eliom_config</a></h2><h2><a href=".././api/server/Eliom_request_info" class="ocsimore_phrasing_link">Eliom_request_info</a></h2><h2><a href=".././api/server/Eliom_reference" class="ocsimore_phrasing_link">Eliom_reference</a></h2><h2><a href=".././api/server/Eliom_state" class="ocsimore_phrasing_link">Eliom_state</a></h2><h2>Content and form creation</h2><h3><a href=".././api/server/Eliom_content" class="ocsimore_phrasing_link">Eliom_content</a></h3><h3><a href=".././api/server/Eliom_content.Html5" class="ocsimore_phrasing_link">Eliom_content.Html5</a></h3><h3><a href=".././api/server/Eliom_content.Svg" class="ocsimore_phrasing_link">Eliom_content.Svg</a></h3><h3><a href=".././api/server/Eliom_content.Xml" class="ocsimore_phrasing_link">Eliom_content.Xml</a></h3><h3><a href=".././api/server/Eliom_tools" class="ocsimore_phrasing_link">Eliom_tools</a></h3><h2>Services creation</h2><h3><a href=".././api/server/Eliom_service" class="ocsimore_phrasing_link">Eliom_service</a></h3><h3><a href=".././api/server/Eliom_parameter" class="ocsimore_phrasing_link">Eliom_parameter</a></h3><h3><a href=".././api/server/Eliom_registration" class="ocsimore_phrasing_link">Eliom_registration</a></h3><h3><a href=".././api/server/Eliom_registration.Html5" class="ocsimore_phrasing_link">Eliom_registration.Html5</a></h3><h3><a href=".././api/server/Eliom_registration.Action" class="ocsimore_phrasing_link">Eliom_registration.Action</a></h3><h3><a href=".././api/server/Eliom_registration.Ocaml" class="ocsimore_phrasing_link">Eliom_registration.Ocaml</a></h3><h3><a href=".././api/server/Eliom_registration.App" class="ocsimore_phrasing_link">Eliom_registration.App</a></h3><h3><a href=".././api/server/Eliom_registration.File" class="ocsimore_phrasing_link">Eliom_registration.File</a></h3><h3><a href=".././api/server/Eliom_registration.Any" class="ocsimore_phrasing_link">Eliom_registration.Any</a></h3><h3><a href=".././api/server/Eliom_registration.Redirection" class="ocsimore_phrasing_link">Eliom_registration.Redirection</a></h3><h2>Client/server communication</h2><h3><a href=".././api/server/Eliom_bus" class="ocsimore_phrasing_link">Eliom_bus</a></h3><h3><a href=".././api/server/Eliom_comet" class="ocsimore_phrasing_link">Eliom_comet</a></h3><h3><a href=".././api/server/Eliom_react" class="ocsimore_phrasing_link">Eliom_react</a></h3><h2>Extensions</h2><h3><a href=".././api/server/Eliom_atom" class="ocsimore_phrasing_link">Eliom_atom</a></h3><h3><a href=".././api/server/Atom_feed" class="ocsimore_phrasing_link">Atom_feed</a></h3><h3><a href=".././api/server/Eliom_openid" class="ocsimore_phrasing_link">Eliom_openid</a></h3><h3><a href=".././api/server/Eliom_s2s" class="ocsimore_phrasing_link">Eliom_s2s</a></h3><h2>Index</h2><h3> <span><a href=".././api/server/index_types">Index of types</a></span></h3><h3> <span><a href=".././api/server/index_exceptions">Index of exceptions</a></span></h3><h3> <span><a href=".././api/server/index_values">Index of values</a></span></h3><h3> <span><a href=".././api/server/index_modules">Index of modules</a></span></h3><h3> <span><a href=".././api/server/index_module_types">Index of module types</a></span></h3></nav></nav></aside></div><p class="reasonwarning">Warning: Reason support is experimental.
We are looking for beta-tester and contributors.
</p><button id="reason">Switch to </button><div class="twocols"><nav class="leftcol">Version <select class="how-versions" onchange="location = this.value;"><option value=".././../1.1.0/manual/clientserver-communication">1.1.0</option><option value=".././../1.2.2/manual/clientserver-communication">1.2.2</option><option value=".././../1.3.4/manual/clientserver-communication">1.3.4</option><option value=".././../2.0.2/manual/clientserver-communication">2.0.2</option><option value=".././../2.1.1/manual/clientserver-communication">2.1.1</option><option value=".././../2.2.2/manual/clientserver-communication">2.2.2</option><option value=".././../3.0/manual/clientserver-communication">3.0</option><option value=".././../4.2/manual/clientserver-communication" selected="selected">4.2</option><option value=".././../5.0/manual/clientserver-communication">5.0</option><option value=".././../6.x/manual/clientserver-communication">6.x</option><option value=".././../dev/manual/clientserver-communication">dev</option></select><nav class="how-doctree"><h1> Eliom's Reference manual</h1><h2><a href="intro" class="ocsimore_phrasing_link">Introduction</a></h2><h2>Server side programming</h2><h3>Services</h3><h4><a href="server-services" class="ocsimore_phrasing_link">The different types of services</a></h4><h4><a href="server-params" class="ocsimore_phrasing_link">Typing service parameters</a></h4><h4><a href="server-outputs" class="ocsimore_phrasing_link">Writing service handlers</a></h4><h4><a href="server-links" class="ocsimore_phrasing_link">Creating links and forms</a></h4><h3><a href="server-state" class="ocsimore_phrasing_link">Sessions and server side state</a></h3><h3><a href="server-security" class="ocsimore_phrasing_link">Security</a></h3><h2>Client-server programming</h2><h3><a href="clientserver-applications" class="ocsimore_phrasing_link">Eliom applications</a></h3><h3><a href="clientserver-language" class="ocsimore_phrasing_link">Client-server syntax</a></h3><h3><a href="clientserver-html" class="ocsimore_phrasing_link">Generating HTML5</a></h3><h3><a href="clientserver-communication" class="ocsimore_phrasing_link">Communication</a></h3><h3><a href="clientserver-mobile" class="ocsimore_phrasing_link">Mobile apps</a></h3><h3><a href="clientserver-wrapping" class="ocsimore_phrasing_link">Custom wrapping</a></h3><h2>Workflows</h2><h3><a href="workflow-distillery" class="ocsimore_phrasing_link">Distillery</a></h3><h3><a href="workflow-compilation" class="ocsimore_phrasing_link">Compilation</a></h3><h3><a href="workflow-configuration" class="ocsimore_phrasing_link">Configuration &amp; running</a></h3><h2><a href="examples" class="ocsimore_phrasing_link">Examples</a></h2><h2><a href="misc" class="ocsimore_phrasing_link">Miscellaneous</a></h2><h1>Eliom client API</h1><h2><a href=".././api/client/Eliom_pervasives" class="ocsimore_phrasing_link">Eliom_pervasives</a></h2><h2><a href=".././api/client/Eliom_lib" class="ocsimore_phrasing_link">Eliom_lib</a></h2><h2><a href=".././api/client/Eliom_client" class="ocsimore_phrasing_link">Eliom_client</a></h2><h2>Content and form creation</h2><h3><a href=".././api/client/Eliom_content.Html5" class="ocsimore_phrasing_link">Eliom_content.Html5</a></h3><h3><a href=".././api/client/Eliom_content.Svg" class="ocsimore_phrasing_link">Eliom_content.Svg</a></h3><h3><a href=".././api/client/Eliom_content.Xml" class="ocsimore_phrasing_link">Eliom_content.Xml</a></h3><h2>Client/server communication</h2><h3><a href=".././api/client/Eliom_service" class="ocsimore_phrasing_link">Eliom_service</a></h3><h3><a href=".././api/client/Eliom_bus" class="ocsimore_phrasing_link">Eliom_bus</a></h3><h3><a href=".././api/client/Eliom_comet" class="ocsimore_phrasing_link">Eliom_comet</a></h3><h3><a href=".././api/client/Eliom_react" class="ocsimore_phrasing_link">Eliom_react</a></h3><h2>Index</h2><h3> <span><a href=".././api/client/index_types">Index of types</a></span></h3><h3> <span><a href=".././api/client/index_exceptions">Index of exceptions</a></span></h3><h3> <span><a href=".././api/client/index_values">Index of values</a></span></h3><h3> <span><a href=".././api/client/index_class_types">Index of class types</a></span></h3><h3> <span><a href=".././api/client/index_modules">Index of modules</a></span></h3><h3> <span><a href=".././api/client/index_module_types">Index of module types</a></span></h3><h1>Server API</h1><h2><a href=".././api/server/Eliom_pervasives" class="ocsimore_phrasing_link">Eliom_pervasives</a></h2><h2><a href=".././api/server/Eliom_lib" class="ocsimore_phrasing_link">Eliom_lib</a></h2><h2><a href=".././api/server/Eliom_common" class="ocsimore_phrasing_link">Eliom_common</a></h2><h2><a href=".././api/server/Eliom_config" class="ocsimore_phrasing_link">Eliom_config</a></h2><h2><a href=".././api/server/Eliom_request_info" class="ocsimore_phrasing_link">Eliom_request_info</a></h2><h2><a href=".././api/server/Eliom_reference" class="ocsimore_phrasing_link">Eliom_reference</a></h2><h2><a href=".././api/server/Eliom_state" class="ocsimore_phrasing_link">Eliom_state</a></h2><h2>Content and form creation</h2><h3><a href=".././api/server/Eliom_content" class="ocsimore_phrasing_link">Eliom_content</a></h3><h3><a href=".././api/server/Eliom_content.Html5" class="ocsimore_phrasing_link">Eliom_content.Html5</a></h3><h3><a href=".././api/server/Eliom_content.Svg" class="ocsimore_phrasing_link">Eliom_content.Svg</a></h3><h3><a href=".././api/server/Eliom_content.Xml" class="ocsimore_phrasing_link">Eliom_content.Xml</a></h3><h3><a href=".././api/server/Eliom_tools" class="ocsimore_phrasing_link">Eliom_tools</a></h3><h2>Services creation</h2><h3><a href=".././api/server/Eliom_service" class="ocsimore_phrasing_link">Eliom_service</a></h3><h3><a href=".././api/server/Eliom_parameter" class="ocsimore_phrasing_link">Eliom_parameter</a></h3><h3><a href=".././api/server/Eliom_registration" class="ocsimore_phrasing_link">Eliom_registration</a></h3><h3><a href=".././api/server/Eliom_registration.Html5" class="ocsimore_phrasing_link">Eliom_registration.Html5</a></h3><h3><a href=".././api/server/Eliom_registration.Action" class="ocsimore_phrasing_link">Eliom_registration.Action</a></h3><h3><a href=".././api/server/Eliom_registration.Ocaml" class="ocsimore_phrasing_link">Eliom_registration.Ocaml</a></h3><h3><a href=".././api/server/Eliom_registration.App" class="ocsimore_phrasing_link">Eliom_registration.App</a></h3><h3><a href=".././api/server/Eliom_registration.File" class="ocsimore_phrasing_link">Eliom_registration.File</a></h3><h3><a href=".././api/server/Eliom_registration.Any" class="ocsimore_phrasing_link">Eliom_registration.Any</a></h3><h3><a href=".././api/server/Eliom_registration.Redirection" class="ocsimore_phrasing_link">Eliom_registration.Redirection</a></h3><h2>Client/server communication</h2><h3><a href=".././api/server/Eliom_bus" class="ocsimore_phrasing_link">Eliom_bus</a></h3><h3><a href=".././api/server/Eliom_comet" class="ocsimore_phrasing_link">Eliom_comet</a></h3><h3><a href=".././api/server/Eliom_react" class="ocsimore_phrasing_link">Eliom_react</a></h3><h2>Extensions</h2><h3><a href=".././api/server/Eliom_atom" class="ocsimore_phrasing_link">Eliom_atom</a></h3><h3><a href=".././api/server/Atom_feed" class="ocsimore_phrasing_link">Atom_feed</a></h3><h3><a href=".././api/server/Eliom_openid" class="ocsimore_phrasing_link">Eliom_openid</a></h3><h3><a href=".././api/server/Eliom_s2s" class="ocsimore_phrasing_link">Eliom_s2s</a></h3><h2>Index</h2><h3> <span><a href=".././api/server/index_types">Index of types</a></span></h3><h3> <span><a href=".././api/server/index_exceptions">Index of exceptions</a></span></h3><h3> <span><a href=".././api/server/index_values">Index of values</a></span></h3><h3> <span><a href=".././api/server/index_modules">Index of modules</a></span></h3><h3> <span><a href=".././api/server/index_module_types">Index of module types</a></span></h3></nav></nav><article class="rightcol"><h1 id="communication"> Communication between the client and the server <a class="backref" href="#communication">&#182;</a></h1><div id="overview" class="ocsimore_outline"><header><p><strong>Table of contents</strong></p></header></div><script>
//<![CDATA[
window.addEventListener("load", function(){ outline([0,-515484383,0,[0,2],[0,"nav",[0,"aside",0]],"overview",1]); }, false); 
//]]>
</script><p>Besides values passed by the mean of the <span class="teletype">%variable</span>
syntax, there are multiple ways for the client and server to exchange
values.
</p><h2 id="rpc"> Remote Procedure Calls <a class="backref" href="#rpc">&#182;</a></h2><p>Eliom provides you an easy way to call server functions from the client:
<span><a href=".././api/server/Eliom_pervasives#TYPEserver_function">Eliom_pervasives.server_function</a></span>
(and on <span><a href=".././api/client/Eliom_pervasives#TYPEserver_function">client</a></span>).
</p><p>A function <span class="monospace">'a -&gt; 'b Lwt.t</span> can me wrapped on the server side by
<span><a href=".././api/server/Eliom_pervasives#VALserver_function">Eliom_pervasives.server_function</a></span>.
When the result is sent to the client, it appears as a plain
function <span class="monospace">'a -&gt; 'b Lwt</span>.
</p><p>It is necessary to provide an instance of <span><a href=".././../../js_of_ocaml/latest/api/Deriving_Json">Deriving_Json</a></span> for the argument type, to
safely send the argument from the client to the server.
</p><p>Every call to <span class="monospace">server_function</span> creates a new non-attached POST
coservice. It is thus advisable to apply it only once and bind it to
an identifier, if it is to be used several times.
</p><p>Example:
</p><pre class=""><code class="language-ocaml translatable">{server{
  let log str = Lwt_io.write_line Lwt_io.stdout str

  let rpc_log = server_function Json.t&lt;string&gt; log
}}

{client{
  let () =
    Eliom_client.onload
      (* NB The service underlying the server_function isn't available on the
         client before loading the page. *)
      (fun () -&gt;
         Lwt.async
           (fun () -&gt;
              %rpc_log &quot;hello from the client to the server!&quot;))
}}</code></pre><p>Exceptions raised in the server-side function cannot be handled
directly on the client (because it's impossible to marshal them in
OCaml to send it to the client).  Instead, if an exception is raised
in the server function, the function application fails (in Lwt) on the
client with the exception <span><a href=".././api/client/Eliom_lib#EXCEPTIONException_on_server">Eliom_lib.Exception_on_server</a></span> whose argument describes the original
exception (according to <span class="teletype">Printexc.to_string</span>).
</p><h2> Client requesting data</h2><p>Server function are implemented using special services taking and
returning OCaml values. In this section we will see how to define
services returning OCaml data.
</p><p>These services are registered using <span><a href=".././api/server/Eliom_registration.Ocaml">Eliom_registration.Ocaml</a></span>
and can be called using
<span><a href=".././api/client/Eliom_client#VALcall_ocaml_service">Eliom_client.call_ocaml_service</a></span>.
</p><p>Those services cannot be visited by the browser as web pages.
You usually want POST coservices for this use.
This corresponds to remote function calls, that are typically
handled by non-attached POST coservices.
</p><p>Example of use:
</p><pre class=""><code class="language-ocaml translatable">open Eliom_content

let pi_service =
  Eliom_registration.Ocaml.register_post_coservice'
    ~post_params:Eliom_parameter.unit
    (fun () () -&gt; Lwt.return 3.1415926535)

let _ =
  My_appl.register_service
    ~path:[&quot;pi&quot;]
    ~get_params:Eliom_parameter.unit
    (fun () () -&gt;
      ignore {unit{
        Lwt.ignore_result(
          lwt pi =
            Eliom_client.call_ocaml_service ~service:%pi_service () ()
          in
	  Lwt.return (
	    Dom_html.window##alert(Js.string
                (&quot;pi = &quot;^(string_of_float pi)))))
      }};
      Lwt.return
        Html5.D.(html
                  (head (title (pcdata &quot;pi&quot;)) [])
                  (body [])))</code></pre><p>Since client and server side value representation are not the same, it
is not possible to send any Ocaml value, the restriction on what can
be sent are the same as for the <span class="teletype">%variable</span> mechanism
(see the <span><a href=".././manual/clientserver-wrapping"> chapter Wrapping</a></span>).
</p><h2 id="client_sending_data">Client sending data <a class="backref" href="#client_sending_data">&#182;</a></h2><p>The client can send OCaml values as parameters to services.
To do that, declare the expected parameter type using
<span><a href=".././api/server/Eliom_parameter#VALocaml">Eliom_parameter.ocaml</a></span>.
</p><p>Since the server can't trust the client to send correcly formed data,
Eliom is not using the standard OCaml marshalling mechanism (the
server needs to be able to check that the value is of the expected
type). For this reason, you must declare the types of the data
you want to be able to send to the server using the <span class="teletype">Deriving</span>
syntax extension:
</p><pre class=""><code class="language-ocaml translatable">{shared{
  type some_type = (int * string list) deriving (Json)
  type another_type =
    | A of some_type
    | B of another_type
    deriving (Json)
}}</code></pre><p>This type can now be used as a parameter for a service:
</p><pre class=""><code class="language-ocaml translatable">open Eliom_content

let s =
  My_appl.register_service
    ~path:[&quot;s1&quot;]
    ~get_params:(ocaml &quot;param&quot; Json.t&lt;another_type&gt;)
    (fun () v -&gt;
      Lwt.return
        Html5.D.(html
                  (head (title (pcdata &quot;title&quot;)))
                  (body [
                    match v with
                      | A _ -&gt; pcdata &quot;A&quot;
                      | B _ -&gt; pcdata &quot;B&quot;
                  ])))

let _ =
  My_appl.register_service
    ~path:[&quot;s2&quot;]
    ~get_params:unit
    (fun () () -&gt;
      Lwt.return
        Html5.D.(html
                  (head (title (pcdata &quot;title&quot;)))
                  (body [
                    [p ~a:[a_onclick
                      {{ ignore (Eliom_client.change_page ~service:%s (A (1,[&quot;s&quot;])) ()) }}]
                      [pcdata &quot;Click to send Ocaml data&quot;]
                  ]])))</code></pre><p>It works for the data types you define, and the data types from
OCaml's standard library. For types defined in third third party
libraries, have a look at deriving's
<a href="http://code.google.com/p/deriving/wiki/Introduction" class="ocsimore_phrasing_link">documentation</a>
and Js_of_ocaml's <span><a href=".././../../js_of_ocaml/latest/api/Deriving_Json">Deriving_Json</a></span>.
</p><aside class="wip"><header><h5>Work in progress</h5></header><p>We are currently working with the OCaml team to make possible to
do that whithout deriving. We hope to have a good solution included in OCaml
as soon as possible.</p></aside><h2> Server sending data</h2><p>Eliom implements some mechanisms to make possible for the server to
send data to a client. We call that mechanism <em>Comet</em>, it is
also sometimes called <em>HTTP push</em>.
</p><p>The simple low level version above which all other following mechanisms are
implemented is provided in the <span><a href=".././api/server/Eliom_comet.Channel">Eliom_comet.Channel</a></span>
module.
</p><p>Comet defines channels which can convey data. A channel is created
using a Lwt stream. It is a kind of cooperative lazy list.
</p><p>The two main methods to create a stream are through the functions
<span><a href=".././../../lwt/latest/api/Lwt_stream#VALfrom">Lwt_stream.from</a></span> and
<span><a href=".././../../lwt/latest/api/Lwt_stream#VALcreate">Lwt_stream.create</a></span>.
</p><pre class=""><code class="language-ocaml translatable">val from : (unit -&gt; 'a option Lwt.t) -&gt; 'a t
val create : unit -&gt; 'a t * ('a option -&gt; unit)</code></pre><p>Function <span><a href=".././../../lwt/latest/api/Lwt_stream#VALfrom">Lwt_stream.from</a></span> makes possible
to create a stream where a new
value is added each time a function returns.
Function <span><a href=".././../../lwt/latest/api/Lwt_stream#VALcreate">Lwt_stream.create</a></span>
returns a stream and a function to push new values to the stream.
</p><p>On client side the type
<span><a href=".././api/client/Eliom_comet.Channel#TYPEt">Eliom_comet.Channel.t</a></span>
is just a Lwt stream <span><a href=".././../../lwt/latest/api/Lwt_stream#TYPEt">Lwt_stream.t</a></span>.
</p><p>There are 3 kind of channels depending on how you want to send data.
</p><ul><li> Channels created with
<span><a href=".././api/server/Eliom_comet.Channel#VALcreate">Eliom_comet.Channel.create</a></span>
have a buffer with a limited size. Message are read from the stream as
soon as they are available, i.e. for stream created with
<span><a href=".././../../lwt/latest/api/Lwt_stream#VALfrom">Lwt_stream.from</a></span>, that means that the
function is called another time as soon as the previous one terminate.
For stream created with <span><a href=".././../../lwt/latest/api/Lwt_stream#VALcreate">Lwt_stream.create</a></span>,
this is as soon as they are pushed. If the client missed too much
messages (more than the size of the buffer) it will receive an exception
<span><a href=".././api/client/Eliom_comet#EXCEPTIONChannel_full">Eliom_comet.Channel_full</a></span>
when reading data from the stream.
</li></ul><ul><li> Channels created with
<span><a href=".././api/server/Eliom_comet.Channel#VALcreate_newest">Eliom_comet.Channel.create_newest</a></span> have no buffering
and can loose messages, but the client will always receive the last value:
For instance if many messages are sent in a short time,
the client may receive only the last one. Those channels never raise
<span><a href=".././api/client/Eliom_comet#EXCEPTIONChannel_full">Eliom_comet.Channel_full</a></span>.
</li></ul><ul><li> Channels created with <span><a href=".././api/server/Eliom_comet.Channel#VALcreate_unlimited">Eliom_comet.Channel.create_unlimited</a></span>
consume data on the stream only when their is a request from the client.
</li></ul><p>Channels can be closed on client side by cancelling a thread waiting
for data on it.
</p><p>Like services, channels have a scope (only site or client process).
The constraints vary with respect to the scope you choose:
</p><ul><li> Channels created with scope <span><a href=".././api/server/Eliom_common#VALsite_scope">Eliom_common.site_scope</a></span> or
using <span><a href=".././api/server/Eliom_comet.Channel#VALcreate_newest">Eliom_comet.Channel.create_newest</a></span>
are stateless channels: the memory consumption does not depend on
the number of users requesting data on it. When the channels are not
reachable from the server code, they are garbage collected and closed.
Named stateless channels can be accessed from
<span><a href=".././manual/clientserver-applications#cors_channels">other servers</a></span>.
</li></ul><ul><li> Channels created with scope <span><a href=".././api/server/Eliom_common#VALdefault_process_scope">Eliom_common.default_process_scope</a></span>
must be created inside a service handler. They
are assigned to a particular client process. Different channels
created with the same stream do not share memory. They are closed
when requested or when the client process is closed. It is possible
to know when a client stop requesting data on those channels using
<span><a href=".././api/server/Eliom_comet.Channel#VALwait_timeout">Eliom_comet.Channel.wait_timeout</a></span>.
</li></ul><p><em>Warning:</em> Be careful about memory consumption when using
client process channels.
</p><h3> Comet configuration</h3><p>The server can push data to a client only when the client has an open
HTTP connection waiting for answer. As of now, a comet request can
only last at most 10 seconds. After that, the client can either do a
new request or stale for some time: this is the activity
behaviour. This can be configured on client side, using the functions from
<span><a href=".././api/client/Eliom_comet.Configuration">Eliom_comet.Configuration</a></span>
</p><p>For instance if you receive data which doesn't need frequent
update, you could set the time between different requests quite high
and stop requesting data as soon as the browser looses the focus.
</p><pre class=""><code class="language-ocaml translatable">open Eliom_comet.Configuration
let slow_c = new_configuration () in
set_active_until_timeout slow_c false;
set_time_between_request slow_c 60.</code></pre><p>If you need more reactivity for a few seconds, do:
</p><pre class=""><code class="language-ocaml translatable">open Eliom_comet.Configuration
let fast_c = new_configuration () in
set_set_always_active fast_c true;
set_set_time_between_request fast_c 0.;
ignore (Lwt_js.sleep 10. &gt;|= (fun () -&gt; drop_configuration fast_c))</code></pre><p>The original setting will be reset after the drop.
</p><h2> Reactive values</h2><p>A common usage of comet is for the server to update a value available
on client side. A convenient way to implement this is to use reactive
programming. Eliom provides a reactive interface for channels, using
Daniel Bünzli's React library.
</p><p>To share a React event or signal with the client, use functions
<span><a href=".././api/server/Eliom_react.Down#VALof_react">Eliom_react.Down.of_react</a></span> or
<span><a href=".././api/server/Eliom_react.S.Down#VALof_react">Eliom_react.S.Down.of_react</a></span>
</p><p>On client side the value returned by those functions is directly
a React event or signal.
</p><p>The contrary is also available using <span><a href=".././api/server/Eliom_react.Up#VALcreate">Eliom_react.Up.create</a></span>.
</p><p>Since this is implemented using comet, tunnig comet configuration will
also affect the behaviour of shared react variables.
</p><h2> Client-Server shared bus</h2><p>It is cometimes useful to have a bidirectionnal channels shared between
multiple clients.
This is the purpose of buses. Those are created using
<span><a href=".././api/server/Eliom_bus#VALcreate">Eliom_bus.create</a></span>. Since the server will also receive data on
the bus, the description of the type (using deriving) is needed to create a bus.
</p><p>Like comet channels, the behaviour of buses can be tuned using the module
<span><a href=".././api/client/Eliom_comet.Configuration">Eliom_comet.Configuration</a></span>.
There are additionnal configurations available on buses to tune the client
side buffering.
</p><h2 id="cors_channels"> Another Server sending data (Comet on another server) <a class="backref" href="#cors_channels">&#182;</a></h2><p>It is possible to access a named stateless channel created on another
server. It has to be declared using <span><a href=".././api/server/Eliom_comet.Channel#VALexternal_channel">Eliom_comet.Channel.external_channel</a></span>. The declaration of the
channel must match exactly the creation. The server generating the
page and the server that created the channel must run exactly the same
version of Eliom. By default a browser can't do requests to a
different server, to allow that the server serving the channel must
allow Cross-Origin Resource Sharing using the <span><a href=".././../../ocsigenserver/latest/manual/cors">CORS Ocsigenserver
extension</a></span>.</p></article></div></div></body></html>
